# Инструкция по настройке Google Sheets для Telegram бота

## Обзор
Данная инструкция поможет вам настроить интеграцию Telegram бота с Google Sheets для автоматического хранения и синхронизации данных о записях к врачам, отзывах и других данных. Google Sheets является единственным источником хранения данных для бота.

## Преимущества Google Sheets
- ✅ Автоматическая синхронизация в реальном времени
- ✅ Доступ из любого места через веб-интерфейс
- ✅ Возможность совместной работы администраторов
- ✅ Автоматическое резервное копирование
- ✅ Интеграция с другими Google сервисами

## Пошаговая настройка

### Шаг 1: Создание Google Cloud Project

1. Перейдите на [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. Включите Google Sheets API:
   - Перейдите в "APIs & Services" > "Library"
   - Найдите "Google Sheets API"
   - Нажмите "Enable"

### Шаг 2: Создание сервисного аккаунта

1. В Google Cloud Console перейдите в "APIs & Services" > "Credentials"
2. Нажмите "Create Credentials" > "Service Account"
3. Заполните форму:
   - **Name**: `telegram-bot-service`
   - **Description**: `Service account for Telegram bot integration`
4. Нажмите "Create and Continue"
5. Пропустите шаги с ролями (нажмите "Continue")
6. Нажмите "Done"

### Шаг 3: Создание ключа сервисного аккаунта

1. В списке сервисных аккаунтов найдите созданный аккаунт
2. Нажмите на email аккаунта
3. Перейдите на вкладку "Keys"
4. Нажмите "Add Key" > "Create new key"
5. Выберите "JSON" формат
6. Нажмите "Create"
7. Файл `telegram-bot-service-xxxxx.json` автоматически скачается

### Шаг 4: Создание Google таблицы

1. Перейдите на [Google Sheets](https://sheets.google.com/)
2. Создайте новую таблицу
3. Скопируйте ID таблицы из URL:
   ```
   https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
                                                                    ↑
                                                              Это ID таблицы
   ```

### Шаг 5: Настройка доступа к таблице

1. В Google таблице нажмите кнопку "Настройки доступа" (справа вверху)
2. Нажмите "Изменить"
3. В поле "Добавить пользователей и группы" введите email сервисного аккаунта:
   ```
   telegram-bot-service@your-project.iam.gserviceaccount.com
   ```
4. Установите права доступа "Редактор"
5. Нажмите "Готово"

### Шаг 6: Настройка переменных окружения

#### Вариант A: Через переменные окружения (рекомендуется для продакшена)

Создайте файл `.env` в корне проекта:

```env
# Токен бота
BOT_TOKEN=your_bot_token_here

# Google Sheets настройки
GOOGLE_SHEETS_ID=1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms
GOOGLE_SERVICE_ACCOUNT_JSON={"type":"service_account","project_id":"your-project","private_key_id":"...","private_key":"-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n","client_email":"telegram-bot-service@your-project.iam.gserviceaccount.com","client_id":"...","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/telegram-bot-service%40your-project.iam.gserviceaccount.com"}

# ID администратора (опционально)
ADMIN_ID=123456789
```

#### Вариант B: Через файл сервисного аккаунта (не рекомендуется для продакшена)

1. Поместите скачанный JSON файл в корень проекта и добавьте его в `.gitignore`
2. Переименуйте его в `service-account.json`
3. Альтернативно к переменной `GOOGLE_SERVICE_ACCOUNT_JSON` можно использовать путь к файлу:

```env
BOT_TOKEN=your_bot_token_here
GOOGLE_SHEETS_ID=1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms
# В продакшене используйте GOOGLE_SERVICE_ACCOUNT_JSON. Этот вариант — только для локальной разработки.
GOOGLE_SERVICE_ACCOUNT_JSON=./service-account.json
ADMIN_ID=123456789
```

#### Вариант C: Для Render.com

В настройках Render добавьте переменные окружения:

- `GOOGLE_SHEETS_ID`: ID вашей таблицы
- `GOOGLE_SERVICE_ACCOUNT_JSON`: содержимое JSON файла в одну строку

### Шаг 7: Установка зависимостей

Убедитесь, что установлены все необходимые пакеты:

```bash
pip install -r requirements.txt
```

## Проверка работы

### Тест подключения

1. Запустите бота
2. В логах должно появиться:
   ```
   INFO - Google Sheets инициализирован успешно
   INFO - Используется Google Sheets
   ```

### Тест синхронизации

1. Создайте запись через бота
2. Проверьте, что данные появились в Google таблице
3. Измените данные в таблице
4. Проверьте, что бот видит изменения

## Структура таблицы

Бот автоматически создаст следующие листы:

### Лист "Записи на прием"
- Дата записи
- Время
- ФИО пациента
- Телефон
- Врач
- Специализация
- Статус
- ID пользователя
- Дата создания

### Лист "Отзывы"
- Дата
- ФИО
- Оценка
- Отзыв
- ID пользователя
- Статус

### Лист "Онлайн консультации"
- Дата
- Вопрос
- ID пользователя
- Статус
- Ответ

### Лист "Подписчики"
- ID пользователя
- Имя
- Дата подписки

## Команды администратора

### /export
- **В режиме Google Sheets**: отправляет ссылку на таблицу
- **В режиме Excel**: отправляет файл Excel

## Устранение неполадок

### Ошибка "Google Sheets недоступен"

1. Проверьте правильность ID таблицы
2. Убедитесь, что сервисный аккаунт имеет доступ к таблице
3. Проверьте формат JSON ключа

### Ошибка "Не удалось получить учетные данные"

1. Проверьте содержимое переменной `GOOGLE_SERVICE_ACCOUNT_JSON`
2. Убедитесь, что JSON файл не поврежден
3. Проверьте права доступа сервисного аккаунта

### Таблица не создается автоматически

1. Проверьте права доступа сервисного аккаунта
2. Убедитесь, что Google Sheets API включен
3. Проверьте логи на наличие ошибок

## Безопасность

⚠️ **Важно**: 
- Никогда не публикуйте JSON ключ сервисного аккаунта
- Не добавляйте его в систему контроля версий
- Используйте переменные окружения для хранения чувствительных данных
- Регулярно ротируйте ключи доступа

## Альтернатива: Fallback на Excel

Если Google Sheets недоступен, бот автоматически переключится на Excel:
- Создаст файл `clinic_data.xlsx`
- Сохранит все данные локально
- В логах появится: `Используется Excel`

## Поддержка

При возникновении проблем:
1. Проверьте логи бота
2. Убедитесь в правильности настройки Google Cloud
3. Проверьте права доступа к таблице
4. Убедитесь в корректности переменных окружения
